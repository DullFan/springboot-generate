{"version":3,"file":"useMultiple.js","sources":["../../src/select-input/useMultiple.tsx"],"sourcesContent":["import { SetupContext, computed, ref, toRefs, Ref } from 'vue';\nimport isObject from 'lodash/isObject';\nimport { TdSelectInputProps, SelectInputChangeContext, SelectInputKeys } from './type';\nimport { SelectInputCommonProperties } from './interface';\nimport TagInput, { TagInputValue, TagInputProps } from '../tag-input';\nimport Loading from '../loading';\nimport useDefault from '../hooks/useDefaultValue';\nimport { usePrefixClass } from '../hooks/useConfig';\nimport { useFormDisabled } from '../form/hooks';\nimport { PopupInstanceFunctions } from '../popup';\n\nexport interface RenderSelectMultipleParams {\n  commonInputProps: SelectInputCommonProperties;\n  onInnerClear: (context: { e: MouseEvent }) => void;\n  popupVisible: boolean;\n  allowInput: boolean;\n}\n\nconst DEFAULT_KEYS = {\n  label: 'label',\n  key: 'key',\n  children: 'children',\n};\n\nexport default function useMultiple(\n  props: TdSelectInputProps,\n  context: SetupContext,\n  popupRef: Ref<PopupInstanceFunctions>,\n) {\n  const { inputValue } = toRefs(props);\n  const classPrefix = usePrefixClass();\n  const tagInputRef = ref();\n  const isMultipleFocus = ref(props.autofocus);\n  const [tInputValue, setTInputValue] = useDefault(\n    inputValue,\n    props.defaultInputValue,\n    props.onInputChange,\n    'inputValue',\n  );\n  const disable = useFormDisabled();\n\n  const iKeys = computed<SelectInputKeys>(() => ({ ...DEFAULT_KEYS, ...props.keys }));\n  const tags = computed<TagInputValue>(() => {\n    if (!(props.value instanceof Array)) {\n      return isObject(props.value) ? [props.value[iKeys.value.label]] : [props.value];\n    }\n    return props.value.map((item) => (isObject(item) ? item[iKeys.value.label] : item));\n  });\n\n  const tPlaceholder = computed<string>(() => (!tags.value || !tags.value.length ? props.placeholder : ''));\n\n  const onTagInputChange = (val: TagInputValue, context: SelectInputChangeContext) => {\n    // 避免触发浮层的显示或隐藏\n    if (context.trigger === 'tag-remove') {\n      context.e?.stopPropagation();\n    }\n    props.onTagChange?.(val, context);\n  };\n\n  const onInputChange: TagInputProps['onInputChange'] = (val, ctx) => {\n    if (ctx.trigger === 'enter' || ctx.trigger === 'blur') return;\n    setTInputValue(val, { trigger: ctx.trigger, e: ctx.e });\n  };\n\n  /**\n   * 筛选器统一特性：\n   * 1. 筛选器按下回车时不清空输入框;\n   * 2. SelectInput 的失焦不等于 TagInput。如点击下拉面板时，TagInput 失去焦点，但 SelectInput 依旧保持聚焦，允许继续选择。\n   */\n  const onBlur: TagInputProps['onBlur'] = (val, ctx) => {\n    const overlayState = popupRef.value?.getOverlayState();\n    if (overlayState?.hover) return;\n    isMultipleFocus.value = false;\n    props.onBlur?.(props.value, { ...ctx, tagInputValue: val });\n  };\n\n  const onFocus: TagInputProps['onFocus'] = (val, ctx) => {\n    const overlayState = popupRef.value?.getOverlayState();\n    if (isMultipleFocus.value || overlayState?.hover) return;\n    isMultipleFocus.value = true;\n    const params = { ...ctx, tagInputValue: val };\n    props.onFocus?.(props.value, params);\n  };\n\n  const onEnter: TagInputProps['onEnter'] = (val, ctx) => {\n    const params = { ...ctx, tagInputValue: val };\n    props.onEnter?.(props.value, params);\n  };\n\n  const renderSelectMultiple = (p: RenderSelectMultipleParams) => {\n    const tagInputProps = {\n      ...p.commonInputProps,\n      tagProps: props.tagProps,\n      label: props.label,\n      autoWidth: props.autoWidth,\n      readonly: props.readonly,\n      placeholder: tPlaceholder.value,\n      minCollapsedNum: props.minCollapsedNum,\n      collapsedItems: props.collapsedItems,\n      tag: props.tag,\n      value: tags.value,\n      valueDisplay: props.valueDisplay,\n      inputValue: p.popupVisible && p.allowInput ? tInputValue.value : '',\n      inputProps: {\n        readonly: !props.allowInput || props.readonly,\n        inputClass: {\n          [`${classPrefix.value}-input--focused`]: p.popupVisible,\n        },\n        ...props.inputProps,\n      },\n      suffixIcon: !disable.value && props.loading ? () => <Loading loading size=\"small\" /> : props.suffixIcon,\n      ...props.tagInputProps,\n    };\n\n    // eslint-disable-next-line\n    const { tips, ...slots } = context.slots;\n    return (\n      <TagInput\n        ref={tagInputRef}\n        {...tagInputProps}\n        v-slots={slots}\n        onInputChange={onInputChange}\n        onChange={onTagInputChange}\n        onClear={p.onInnerClear}\n        onBlur={onBlur}\n        onEnter={onEnter}\n        onFocus={onFocus}\n      />\n    );\n  };\n\n  return {\n    tags,\n    tPlaceholder,\n    tagInputRef,\n    isMultipleFocus,\n    multipleInputValue: tInputValue,\n    renderSelectMultiple,\n  };\n}\n"],"names":["DEFAULT_KEYS","label","key","children","useMultiple","props","context","popupRef","_toRefs","toRefs","inputValue","classPrefix","usePrefixClass","tagInputRef","ref","isMultipleFocus","autofocus","_useDefault","useDefault","defaultInputValue","onInputChange","_useDefault2","_slicedToArray","tInputValue","setTInputValue","disable","useFormDisabled","iKeys","computed","_objectSpread","keys","tags","value","Array","isObject","map","item","tPlaceholder","length","placeholder","onTagInputChange","val","_props$onTagChange","trigger","_context2$e","e","stopPropagation","onTagChange","call","ctx","onBlur","_popupRef$value","_props$onBlur","overlayState","getOverlayState","hover","tagInputValue","onFocus","_popupRef$value2","_props$onFocus","params","onEnter","_props$onEnter","renderSelectMultiple","p","tagInputProps","commonInputProps","tagProps","autoWidth","readonly","minCollapsedNum","collapsedItems","tag","valueDisplay","popupVisible","allowInput","inputProps","inputClass","_defineProperty","concat","suffixIcon","loading","_createVNode","Loading","_context$slots","slots","tips","_objectWithoutProperties","_excluded","TagInput","_mergeProps","onInnerClear","multipleInputValue"],"mappings":"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"}