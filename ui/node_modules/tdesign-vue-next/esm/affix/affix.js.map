{"version":3,"file":"affix.js","sources":["../../src/affix/affix.tsx"],"sourcesContent":["import { ref, watch, nextTick, onMounted, onBeforeUnmount, defineComponent, onActivated, onDeactivated } from 'vue';\nimport isFunction from 'lodash/isFunction';\nimport isUndefined from 'lodash/isUndefined';\n\nimport { on, off, getScrollContainer } from '../utils/dom';\nimport props from './props';\nimport { ScrollContainerElement } from '../common';\nimport { usePrefixClass } from '../hooks/useConfig';\nimport { useTNodeJSX } from '../hooks/tnode';\n\nexport default defineComponent({\n  name: 'TAffix',\n  props,\n  emits: ['fixedChange'],\n  setup(props, context) {\n    const COMPONENT_NAME = usePrefixClass('affix');\n    const renderTNodeJSX = useTNodeJSX();\n\n    const affixWrapRef = ref<HTMLElement>(null);\n    const affixRef = ref<HTMLElement>(null);\n    const placeholderEL = ref(document?.createElement('div')); // 占位节点\n    const ticking = ref(false);\n    const binded = ref(false);\n\n    const scrollContainer = ref<ScrollContainerElement>();\n    const affixStyle = ref<Record<string, any>>();\n    let rAFId = 0;\n\n    const handleScroll = () => {\n      if (!ticking.value) {\n        rAFId = window.requestAnimationFrame(() => {\n          rAFId = 0;\n          const {\n            top: wrapToTop,\n            width: wrapWidth,\n            height: wrapHeight,\n          } = affixWrapRef.value?.getBoundingClientRect() ?? { top: 0, width: 0, height: 0 }; // top = 节点到页面顶部的距离，包含 scroll 中的高度\n\n          let containerTop = 0; // containerTop = 容器到页面顶部的距离\n          if (scrollContainer.value instanceof HTMLElement) {\n            containerTop = scrollContainer.value.getBoundingClientRect().top;\n          }\n\n          let fixedTop: number | false; // 0 -1 false 都有具体的意义\n          const calcTop = wrapToTop - containerTop; // 节点顶部到 container 顶部的距离\n\n          const containerHeight =\n            scrollContainer.value[scrollContainer.value instanceof Window ? 'innerHeight' : 'clientHeight'] -\n            wrapHeight;\n          const calcBottom = containerTop + containerHeight - props.offsetBottom; // 计算 bottom 相对应的 top 值\n\n          if (!isUndefined(props.offsetTop) && calcTop <= props.offsetTop) {\n            // top 的触发\n            fixedTop = containerTop + props.offsetTop;\n          } else if (!isUndefined(props.offsetBottom) && wrapToTop >= calcBottom) {\n            // bottom 的触发\n            fixedTop = calcBottom;\n          } else {\n            fixedTop = false;\n          }\n\n          if (affixRef.value) {\n            const affixed = fixedTop !== false;\n            const placeholderStatus = affixWrapRef.value.contains(placeholderEL.value);\n\n            if (affixed) {\n              affixRef.value.className = COMPONENT_NAME.value;\n              affixStyle.value = {\n                top: `${fixedTop}px`,\n                width: `${wrapWidth}px`,\n                height: `${wrapHeight}px`,\n                zIndex: props.zIndex,\n              };\n\n              if (!placeholderStatus) {\n                placeholderEL.value.style.width = `${wrapWidth}px`;\n                placeholderEL.value.style.height = `${wrapHeight}px`;\n                affixWrapRef.value.appendChild(placeholderEL.value);\n              }\n            } else {\n              affixRef.value.removeAttribute('class');\n              affixStyle.value = undefined;\n              placeholderStatus && placeholderEL.value.remove();\n            }\n\n            context.emit('fixedChange', affixed, { top: Number(fixedTop) });\n            if (isFunction(props.onFixedChange)) props.onFixedChange(affixed, { top: Number(fixedTop) });\n          }\n\n          ticking.value = false;\n        });\n        ticking.value = true;\n      }\n    };\n\n    const bindScroll = async () => {\n      await nextTick();\n      if (binded.value) return;\n      scrollContainer.value = getScrollContainer(props.container);\n      on(scrollContainer.value, 'scroll', handleScroll);\n      on(window, 'resize', handleScroll);\n      binded.value = true;\n    };\n\n    const unbindScroll = () => {\n      if (!scrollContainer.value || !binded.value) return;\n      off(scrollContainer.value, 'scroll', handleScroll);\n      off(window, 'resize', handleScroll);\n      if (rAFId) {\n        window.cancelAnimationFrame(rAFId);\n      }\n      binded.value = false;\n    };\n\n    watch(\n      () => props.offsetTop,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.offsetBottom,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.zIndex,\n      () => {\n        handleScroll();\n      },\n    );\n\n    onMounted(bindScroll);\n\n    onActivated(bindScroll);\n\n    onDeactivated(unbindScroll);\n\n    onBeforeUnmount(unbindScroll);\n\n    return {\n      affixWrapRef,\n      affixRef,\n      bindScroll,\n      unbindScroll,\n      handleScroll,\n      scrollContainer,\n      renderTNodeJSX,\n      affixStyle,\n    };\n  },\n  render() {\n    return (\n      <div ref=\"affixWrapRef\">\n        <div ref=\"affixRef\" style={this.affixStyle}>\n          {this.renderTNodeJSX('default')}\n        </div>\n      </div>\n    );\n  },\n});\n"],"names":["defineComponent","name","props","emits","setup","context","_document","COMPONENT_NAME","usePrefixClass","renderTNodeJSX","useTNodeJSX","affixWrapRef","ref","affixRef","placeholderEL","document","createElement","ticking","binded","scrollContainer","affixStyle","rAFId","handleScroll","value","window","requestAnimationFrame","_affixWrapRef$value$g","_affixWrapRef$value","_ref","getBoundingClientRect","top","width","height","wrapToTop","wrapWidth","wrapHeight","containerTop","HTMLElement","fixedTop","calcTop","containerHeight","Window","calcBottom","offsetBottom","isUndefined","offsetTop","affixed","placeholderStatus","contains","className","zIndex","style","concat","appendChild","removeAttribute","remove","emit","Number","isFunction","onFixedChange","bindScroll","_callee","_regeneratorRuntime","wrap","_callee$","_context","prev","next","nextTick","abrupt","getScrollContainer","container","on","stop","unbindScroll","off","cancelAnimationFrame","watch","onMounted","onActivated","onDeactivated","onBeforeUnmount","render","_createVNode"],"mappings":"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"}